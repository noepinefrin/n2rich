{% extends 'base.html' %}

{% load static %}
{% load static tailwind_tags %}
{% load dbprocessor %}

{% block content %}
<section class="w-fit mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 md:grid-cols-2 gap-y-16 mt-10 mb-5 md:px-2 lg:px-8">
    {% for db in request.session.field_dbs %}
    <div class="flex justify-center">
    <div class="w-full bg-white shadow-md rounded-xl mx-4">
        <div class="px-4 py-3 w-96">
            <p class="text-lg font-black font-mono text-slate-700 truncate block capitalize">{{ db|replacedb:"_" }}</p>
        </div>
        <div class="flex flex-wrap" id="{{ db }}-tabs-id">

            <div class="w-full h-80 px-4 py-2 bg-blue-50/50">
                <div class="break-words rounded">
                <div class="">
                    <div class="tab-content tab-space">
                    <div class="block" id="{{db}}-tab-datatable">
                        <p>
                        Comparing yourself to others is the thief of joy.
                        </p>
                    </div>
                    <div class="hidden" id="{{db}}-tab-graphs">
                        <p>
                        Because it's about motivating the doers. Because I'm here to follow my dreams and inspire other people to follow their dreams, too.
                        </p>
                    </div>
                    <div class="hidden" id="{{db}}-tab-networks">
                        <p>
                        The reading of all good books is like a conversation with the finest minds of past centuries.
                        </p>
                    </div>
                    </div>
                </div>
                </div>
            </div>

                <ul class="flex flex-auto justify-between px-1 py-3 mx-2">
                    <li>
                    <a class="cursor-pointer text-xs font-semibold uppercase px-10 md:px-12 lg:px-16 py-3 shadow-lg rounded block leading-normal text-white ease-in-out duration-300 bg-blue-600" onclick="changeAtiveTab(event,'{{ db }}-tab-datatable', '{{ db }}')">
                        Data Table
                    </a>
                    </li>
                    <li>
                    <a class="cursor-pointer text-xs font-semibold uppercase px-10 md:px-12 lg:px-16 py-3 shadow-lg rounded block leading-normal text-blue-600 ease-in-out duration-300 bg-white" onclick="changeAtiveTab(event,'{{ db }}-tab-graphs', '{{ db }}')">
                        Graphs
                    </a>
                    </li>
                    <li>
                    <a class="cursor-pointer text-xs font-semibold uppercase px-10 md:px-12 lg:px-16 py-3 shadow-lg rounded block leading-normal text-blue-600 ease-in-out duration-300 bg-white" onclick="changeAtiveTab(event,'{{ db }}-tab-networks', '{{ db }}')">
                        Networks
                    </a>
                    </li>
                </ul>
            </div>
    </div>
</div>
    {% endfor %}
</div>
</section>

<!--MODAL-->
  <div class="flex overflow-x-hidden overflow-y-auto fixed inset-0 z-50 outline-none focus:outline-none justify-center items-center" id="modal-id">
    <div class="relative w-5/6 lg:w-1/3 mx-auto max-w-3xl">
      <!--content-->
      <div class="border-0 rounded-lg shadow-lg relative flex flex-col w-full bg-blue-50/90 outline-none focus:outline-none">
        <!--header-->
        <div class="flex items-center justify-between px-3 py-3 border-b border-solid border-slate-300 rounded-t">
            <div>
                <span id="progress-bar-state" class="text-xs font-bold inline-block py-1 px-2 uppercase rounded-md text-orange-600 bg-orange-200">
                Task in queue
                </span>
            </div>
            <div>
                <span id="progress-bar-percent" class="text-sm rounded-full font-bold tracking-wide inline-block text-blue-600">
                30%
                </span>
            </div>
        </div>
        <!--body-->
        <div class="text-center mb-12 bg-slate-500 text-slate-200">
            <p id="progress-task-id" value="{{ request.session.task_id }}" class="py-2.5 text-sm font-semibold font-mono leading-relaxed">{{request.session.task_id}}</p>
        </div>
        <div class="mb-16 mt-6">

            <div id="progress-wrapper" class="overflow-hidden h-4 mx-16 text-xs mb-1 flex rounded-md bg-blue-200">
                <div id="progress-bar" style="width:30%" class="transition-all ease-out duration-1000 shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500">
                </div>
            </div>
            <div id="progress-bar-message" class="mt-4 mx-16 flex font-bold items-center justify-center text-center text-base text-slate-600">
            </div>

        </div>
        <!--footer-->
        <div class="flex items-center justify-center border-t border-solid border-slate-300">
            <button id="progress-button" type="button" class="inline-flex mt-4 mb-4 items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-emerald-700 hover:bg-emerald-600 transition ease-in-out duration-150 cursor-not-allowed" onclick="toggleModal('modal-id')" disabled>
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Results are rendering. Please wait...
              </button>
        </div>
      </div>
    </div>
  </div>
  <div class="flex opacity-70 fixed inset-0 z-40 bg-black" id="modal-id-backdrop"></div>
</main>
  <script type="text/javascript">
    function toggleModal(modalID){
      document.getElementById(modalID).classList.toggle("hidden");
      document.getElementById(modalID + "-backdrop").classList.toggle("hidden");
      document.getElementById(modalID).classList.toggle("flex");
      document.getElementById(modalID + "-backdrop").classList.toggle("flex");
    }
  </script>

    <script src="{% static 'celery_progress/celery_progress.js' %}"></script>

    <script>

        function stateHandler(stateElement, percentElement, remove_classes, add_classes, state) {
            for (cls of remove_classes) {
                stateElement.classList.remove(cls)
            }

            for (cls2 of add_classes) {
                stateElement.classList.add(cls2)
            }

            progressBarState.textContent = state

            percentElement.classList.remove('text-blue-600')
            percentElement.classList.add('text-emerald-600')
        }

        function customSuccess(progressBarElement, progressBarMessageElement) {
            progressBarElement.style.backgroundColor = '#34d399';
            progressBarMessageElement.textContent = 'The analysis has been completed successfully.'
            let progressButton = document.getElementById('progress-button')
            progressButton.disabled = false
            progressBarState = document.getElementById('progress-bar-state')
            progressBarPercent = document.getElementById('progress-bar-percent')
            stateHandler(progressBarState, progressBarPercent, ["text-blue-600", "bg-blue-200"], ["text-emerald-600", "bg-emerald-200"], 'TASK SUCCESS')
        }

        function onResultDefault(resultElement, result) {
        if (resultElement) {
            resultElement.textContent = result;
            }
        }

        function customProgress(progressBarElement, progressBarMessageElement, progress) {
            progressBarElement.style.backgroundColor = "#2563eb";
            let progressBarState = document.getElementById('progress-bar-state')
            let progressBarPercent = document.getElementById('progress-bar-percent')
            progressBarPercent.textContent = progress.percent + "%";
            progressBarElement.style.width = progress.percent + "%";
            var description = progress.description || "";
            if (progress.current == 0) {
                if (progress.pending === true) {
                    progressBarMessageElement.textContent = 'Your biomarker candidates has been added into queue. Please wait...';
                    progressBarState.textContent = 'Task in queue'
                } else {
                    progressBarMessageElement.textContent = 'Enrichment Analysis started...';
                }
            } else {
                progressBarMessageElement.textContent = progress.current + ' of ' + progress.total + ' processed. ' + description;
                progressBarState.classList.remove('text-orange-600')
                progressBarState.classList.remove('bg-orange-200')
                progressBarState.classList.add('text-blue-600')
                progressBarState.classList.add('bg-blue-200')
                progressBarState.textContent = 'Task in progress'
            }
        }

        // vanilla JS version
        document.addEventListener("DOMContentLoaded", function () {
            var progressUrl = "{% url 'celery_progress:task_status' request.session.task_id %}";
            console.log(progressUrl)
            CeleryProgressBar.initProgressBar(progressUrl, {
                onProgress: customProgress,
                onSuccess: customSuccess
            });
        });

    </script>
    <script>
        function changeAtiveTab(event,tabID, db){
          let element = event.target;
          while(element.nodeName !== "A"){
            element = element.parentNode;
          }
          ulElement = element.parentNode.parentNode;
          aElements = ulElement.querySelectorAll("li > a");
          tabContents = document.getElementById(`${db}-tabs-id`).querySelectorAll(".tab-content > div");
          console.log(tabContents)
          for(let i = 0 ; i < aElements.length; i++){
            aElements[i].classList.remove("text-white");
            aElements[i].classList.remove("bg-blue-600");

            aElements[i].classList.add("text-blue-600");
            aElements[i].classList.add("bg-white");

            tabContents[i].classList.add("hidden");
            tabContents[i].classList.remove("block");
          }
          element.classList.remove("text-blue-600");
          element.classList.remove("bg-white");
          element.classList.add("text-white");
          element.classList.add("bg-blue-600");
          document.getElementById(tabID).classList.remove("hidden");
          document.getElementById(tabID).classList.add("block");
        }
      </script>

{% endblock content %}